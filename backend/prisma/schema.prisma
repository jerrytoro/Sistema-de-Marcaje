// Prisma Schema File - Compatible con Prisma 7.x
// Sistema de Asistencia con Reconocimiento Facial

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enumeraciones
enum RolUsuario {
  ADMIN
  RRHH
  FUNCIONARIO
}

enum TipoMarcaje {
  INGRESO_MANANA
  SALIDA_DESCANSO
  INGRESO_TARDE
  SALIDA_FINAL
}

enum EstadoNotificacion {
  PENDIENTE
  ENVIADO
  FALLIDO
}

// Modelo: Usuario
model Usuario {
  id           Int          @id @default(autoincrement())
  username     String       @unique @db.VarChar(50)
  password     String       @db.VarChar(255)
  rol          RolUsuario   @default(FUNCIONARIO)
  estado       Boolean      @default(true)
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  
  // Relaciones
  funcionario  Funcionario?

  @@map("usuarios")
}

// Modelo: Funcionario
model Funcionario {
  id          Int      @id @default(autoincrement())
  nombre      String   @db.VarChar(100)
  apellido    String   @db.VarChar(100)
  cargo       String   @db.VarChar(100)
  dependencia String   @db.VarChar(150)
  estado      Boolean  @default(true)
  usuarioId   Int      @unique @map("usuario_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  telegramChatId         String? @map("telegram_chat_id")
  facialDataRegistered   Boolean  @default(false) @map("facial_data_registered")

  // Relaciones
  usuario           Usuario             @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  registrosFaciales RegistroFacial[]
  asistencias       Asistencia[]
  resumenesMensuales ResumenMensual[]
  facialData           FacialData?
  telegramLinkTokens   TelegramLinkToken[]

  @@map("funcionarios")
}

// Modelo: Configuracion de Horarios
model ConfiguracionHorario {
  id                 Int          @id @default(autoincrement())
  tipoMarcaje        TipoMarcaje  @unique @map("tipo_marcaje")
  horaProgramada     String       @db.VarChar(5) @map("hora_programada")
  toleranciaMinutos  Int          @default(0) @map("tolerancia_minutos")
  createdAt          DateTime     @default(now()) @map("created_at")
  updatedAt          DateTime     @updatedAt @map("updated_at")

  @@map("configuracion_horarios")
}

// Modelo: Registro Facial
model RegistroFacial {
  id              Int      @id @default(autoincrement())
  funcionarioId   Int      @map("funcionario_id")
  embedding       String   @db.Text
  fechaRegistro   DateTime @default(now()) @map("fecha_registro")
  activo          Boolean  @default(true)

  // Relaciones
  funcionario Funcionario @relation(fields: [funcionarioId], references: [id], onDelete: Cascade)

  @@index([funcionarioId])
  @@map("registros_faciales")
}

// Modelo: Asistencia
model Asistencia {
  id               Int           @id @default(autoincrement())
  funcionarioId    Int           @map("funcionario_id")
  fecha            DateTime      @db.Date
  horaMarcaje      DateTime      @map("hora_marcaje")
  tipoMarcaje      TipoMarcaje   @map("tipo_marcaje")
  minutosTardanza  Int           @default(0) @map("minutos_tardanza")
  verificado       Boolean       @default(true)
  observacion      String?       @db.VarChar(255)
  createdAt        DateTime      @default(now()) @map("created_at")

  // Relaciones
  funcionario       Funcionario         @relation(fields: [funcionarioId], references: [id], onDelete: Cascade)
  logsNotificacion  LogNotificacion[]
  marcajeFacial   MarcajeFacial?  // Relación 1:1 con evidencia facial

  @@unique([funcionarioId, fecha, tipoMarcaje], name: "unique_marcaje_diario")
  @@index([funcionarioId, fecha])
  @@map("asistencias")
}

// Modelo: Log de Notificaciones
model LogNotificacion {
  id            Int                 @id @default(autoincrement())
  asistenciaId  Int                 @map("asistencia_id")
  canal         String              @db.VarChar(50)
  fechaEnvio    DateTime            @default(now()) @map("fecha_envio")
  estado        EstadoNotificacion  @default(PENDIENTE)
  mensajeError  String?             @db.Text @map("mensaje_error")

  // Relaciones
  asistencia Asistencia @relation(fields: [asistenciaId], references: [id], onDelete: Cascade)

  @@index([asistenciaId])
  @@map("logs_notificacion")
}

// Modelo: Resumen Mensual
model ResumenMensual {
  id                      Int       @id @default(autoincrement())
  funcionarioId           Int       @map("funcionario_id")
  anio                    Int
  mes                     Int
  totalDiasTrabajados     Int       @default(0) @map("total_dias_trabajados")
  totalMinutosTardanza    Int       @default(0) @map("total_minutos_tardanza")
  totalMinutosTrabajados  Int       @default(0) @map("total_minutos_trabajados")
  totalAusencias          Int       @default(0) @map("total_ausencias")
  totalPermisos           Int       @default(0) @map("total_permisos")
  reporteGenerado         Boolean   @default(false) @map("reporte_generado")
  urlReportePdf           String?   @db.VarChar(255) @map("url_reporte_pdf")
  fechaGeneracion         DateTime  @default(now()) @map("fecha_generacion")

  // Relaciones
  funcionario Funcionario @relation(fields: [funcionarioId], references: [id], onDelete: Cascade)

  @@unique([funcionarioId, anio, mes], name: "unique_resumen_mensual")
  @@index([funcionarioId, anio, mes])
  @@map("resumenes_mensuales")
}

// 2. NUEVA TABLA: FACIAL DATA
model FacialData {
  id             Int      @id @default(autoincrement())
  funcionarioId  Int      @unique @map("funcionario_id")
  descriptores   Json     // Array de descriptores faciales (Float32Array serializado)
  fotoReferencia String   // URL o path de la foto de referencia
  activo         Boolean  @default(true)
  confianza      Float    @default(0.7) // Umbral de confianza para verificación (0-1)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  funcionario    Funcionario      @relation(fields: [funcionarioId], references: [id], onDelete: Cascade)
  
  @@map("facial_data")
}

// 3. NUEVA TABLA: MARCAJES FACIALES (Evidencia)
model MarcajeFacial {
  id            Int      @id @default(autoincrement())
  asistenciaId  Int      @unique @map("asistencia_id")
  fotoEvidencia String   @map("foto_evidencia")// URL o path de la foto capturada al hacer el marcaje
  confidence    Float    // Nivel de confianza de la comparación (0-1)
  createdAt     DateTime @default(now()) @map("created_at")

  asistencia    Asistencia @relation(fields: [asistenciaId], references: [id], onDelete: Cascade)
  
  @@map("marcajes_faciales")
}

// 4. NUEVA TABLA: TELEGRAM LINK TOKENS
model TelegramLinkToken {
  id            Int      @id @default(autoincrement())
  token         String   @unique // Token único para vincular Telegram
  funcionarioId Int      @map("funcionario_id")
  expiresAt     DateTime @map("expires_at") // Expira en 24 horas
  usado         Boolean  @default(false) // Si ya fue usado
  createdAt     DateTime @default(now()) @map("created_at")

  funcionario   Funcionario @relation(fields: [funcionarioId], references: [id], onDelete: Cascade)
  
  @@map("telegram_link_tokens")
}